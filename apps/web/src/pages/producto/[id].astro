---
import Layout from "../layouts/Layout.astro";
import { createQregaloClient } from "@qregalo/api-client";
import { getEstimatedPriceUSD, getEstimatedPriceUYU } from "@qregalo/domain";
import { formatPrice } from "@qregalo/shared";
import { AnalyticsTracker } from "@qregalo/analytics";
import { getSupabaseConfig } from "../utils/env";

const { url: supabaseUrl, anonKey: supabaseKey } = getSupabaseConfig();
const client = createQregaloClient({ url: supabaseUrl, anonKey: supabaseKey });
const tracker = new AnalyticsTracker(client);

const { id } = Astro.params;
const sessionId = Astro.url.searchParams.get("session_id") || "";
let product = null;
let store = null;
let error = null;

if (id) {
  try {
    product = await client.getProduct(id);
    if (product) {
      store = await client.getStore(product.store_id);
    }
  } catch (e) {
    error = e instanceof Error ? e.message : "Error desconocido";
    console.error("Error loading product:", e);
  }
}

const estimatedUSD = product ? getEstimatedPriceUSD(product) : null;
const estimatedUYU = product ? getEstimatedPriceUYU(product) : null;
---

<Layout title={product ? `${product.title} - QueRegalo Catalog` : "Producto no encontrado"}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {error && (
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <p class="text-red-800">Error: {error}</p>
      </div>
    )}

    {!product && !error && (
      <div class="text-center py-12">
        <p class="text-gray-600 mb-4">Producto no encontrado</p>
        <a href="/" class="text-blue-600 hover:text-blue-700 underline">
          Volver al inicio
        </a>
      </div>
    )}

    {product && (
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        {product.image_url && (
          <img
            src={product.image_url}
            alt={product.title}
            class="w-full h-96 object-cover"
          />
        )}
        <div class="p-8">
          <h1 class="text-3xl font-bold mb-4">{product.title}</h1>
          <p class="text-gray-700 mb-6">{product.description}</p>

          {store && (
            <div class="mb-6">
              <p class="text-sm text-gray-600 mb-1">Tienda:</p>
              <a
                href={store.website_url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-600 hover:text-blue-700 font-semibold"
              >
                {store.name}
              </a>
            </div>
          )}

          {product.location && (
            <div class="mb-6">
              <p class="text-sm text-gray-600 mb-1">Ubicaci√≥n:</p>
              <p class="text-gray-900">üìç {product.location}</p>
            </div>
          )}

          {product.tags.length > 0 && (
            <div class="mb-6">
              <p class="text-sm text-gray-600 mb-2">Etiquetas:</p>
              <div class="flex flex-wrap gap-2">
                {product.tags.map((tag) => (
                  <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          )}

          <div class="border-t pt-6 mb-6">
            <div class="mb-4">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-3xl font-bold text-gray-900">
                  {formatPrice(product.price_original, product.currency_original)}
                </span>
                <span class="px-3 py-1 text-sm font-semibold bg-blue-100 text-blue-800 rounded">
                  Oficial
                </span>
              </div>

              {estimatedUSD && (
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-xl text-gray-700">
                    {estimatedUSD.formatted}
                  </span>
                  <span class="px-3 py-1 text-sm font-semibold bg-gray-100 text-gray-700 rounded">
                    Estimado
                  </span>
                </div>
              )}

              {estimatedUYU && product.currency_original !== "UYU" && (
                <div class="flex items-center gap-3">
                  <span class="text-xl text-gray-700">
                    {estimatedUYU.formatted}
                  </span>
                  <span class="px-3 py-1 text-sm font-semibold bg-gray-100 text-gray-700 rounded">
                    Estimado
                  </span>
                </div>
              )}
            </div>
          </div>

          <a
            href={product.original_url}
            target="_blank"
            rel="noopener noreferrer"
            class="block w-full px-6 py-4 bg-blue-600 text-white text-center rounded-lg font-semibold hover:bg-blue-700 transition-colors text-lg"
            id="ver-en-tienda"
            data-product-id={product.id}
            data-store-id={product.store_id}
            data-session-id={sessionId}
          >
            Ver en tienda
          </a>
        </div>
      </div>
    )}
  </div>
</Layout>

<script define:vars={{ productId: product?.id, storeId: product?.store_id, sessionId }}>
  // Track click on "Ver en tienda" button
  const button = document.getElementById("ver-en-tienda");
  if (button && productId && storeId && sessionId) {
    button.addEventListener("click", async (e) => {
      // Small delay to ensure click is tracked before navigation
      e.preventDefault();
      
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

      if (!supabaseUrl || !supabaseKey) {
        console.warn(
          "Supabase credentials not configured. Click tracking disabled.\n" +
          "Please configure PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_ANON_KEY in Vercel."
        );
        // Still open the store URL even if tracking fails
        window.open(button.href, "_blank");
        return;
      }

      try {
        await fetch(`${supabaseUrl}/rest/v1/product_clicks`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${supabaseKey}`,
            apikey: supabaseKey,
            Prefer: "return=minimal",
          },
          body: JSON.stringify({
            session_id: sessionId,
            product_id: productId,
            store_id: storeId,
            user_agent: navigator.userAgent,
            referrer: document.referrer || null,
          }),
        });
      } catch (error) {
        console.error("Error tracking click:", error);
        // Still open the store URL even if tracking fails
      }

      // Open store URL
      window.open(button.href, "_blank");
    });
  }
</script>
